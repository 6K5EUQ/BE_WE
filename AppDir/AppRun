#!/bin/bash
SELF=$(readlink -f "$0")
HERE=$(dirname "$SELF")
export APPDIR="$HERE"
export PATH="$HERE/usr/bin:$PATH"
export LD_LIBRARY_PATH="$HERE/usr/lib:$LD_LIBRARY_PATH"

# --install-udev 옵션: udev 규칙 설치 후 종료
if [ "$1" = "--install-udev" ]; then
    if [ "$EUID" -ne 0 ]; then
        echo "root 권한 필요: sudo $SELF --install-udev"
        exit 1
    fi
    echo "SUBSYSTEM=="usb", ATTR{idVendor}=="2cf0", MODE="0664", GROUP="plugdev""         > /etc/udev/rules.d/88-nuand.rules
    echo "SUBSYSTEM=="usb", ATTRS{idVendor}=="0bda", ATTRS{idProduct}=="2832", GROUP="plugdev", MODE="0664""         > /etc/udev/rules.d/20-rtlsdr.rules
    echo "SUBSYSTEM=="usb", ATTRS{idVendor}=="0bda", ATTRS{idProduct}=="2838", GROUP="plugdev", MODE="0664""         >> /etc/udev/rules.d/20-rtlsdr.rules
    udevadm control --reload-rules
    udevadm trigger
    ACTUAL_USER="${SUDO_USER:-$USER}"
    usermod -aG plugdev "$ACTUAL_USER"
    echo "Done. 재로그인 후 SDR 장치 사용 가능합니다."
    exit 0
fi

# udev 규칙 확인
if [ ! -f /etc/udev/rules.d/88-nuand.rules ] && [ ! -f /lib/udev/rules.d/88-nuand.rules ]; then
    echo "[BEWE] BladeRF udev rules not found."
    echo "       Run: sudo $SELF --install-udev"
fi
exec "$HERE/usr/bin/BE_WE" "$@"
